<!DOCTYPE html>
<html lang="en">
<head>
    <title>Register</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148651561-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-148651561-1');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="login_register/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="login_register/vendor/animate/animate.css">
    <link rel="stylesheet" type="text/css" href="login_register/vendor/css-hamburgers/hamburgers.min.css">
    <link rel="stylesheet" type="text/css" href="login_register/vendor/select2/select2.min.css">
    <link rel="stylesheet" type="text/css" href="login_register/css/util.css">
    <link rel="stylesheet" type="text/css" href="login_register/css/main.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
    <div class="limiter">
        <div class="container-login100">
            <div class="wrap-login100">
                <div class="login100-pic js-tilt" data-tilt>
                    <img src="login_register/images/img-01.png" alt="IMG">
                </div>

                <div class="login100-form validate-form">
                    <span class="login100-form-title">
                        Register
                    </span>

                    <div class="wrap-input100 validate-input" data-validate="Nickname is required">
                        <input class="input100" type="text" id="nickname" name="nickname" placeholder="Nickname">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-envelope" aria-hidden="true"></i>
                        </span>
                    </div>

                    <div class="wrap-input100 validate-input" data-validate="Password is required">
                        <input class="input100" type="password" id="password" name="pass" placeholder="Password">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-lock" aria-hidden="true"></i>
                        </span>
                    </div>

                    <div class="wrap-input100">
                        <input class="input100" type="text" id="name" name="name" placeholder="Name (optional)">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>

                    <div class="wrap-input100">
                        <input class="input100" type="text" id="surname" name="surname" placeholder="Surname (optional)">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>
                    
                    <div class="container-login100-form-btn">
                        <button class="login100-form-btn" onclick="register();">
                            Register
                        </button>
                    </div>

                    <div class="text-center p-t-140">
                    </div>

                </div>
                
            </div>
        </div>
    </div>

    <script src="login_register/vendor/bootstrap/js/popper.js"></script>
    <script src="login_register/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="login_register/vendor/select2/select2.min.js"></script>
    <script src="login_register/vendor/tilt/tilt.jquery.min.js"></script>
    <script>
        $('.js-tilt').tilt({
            scale: 1.1
        })
    </script>
</body>
</html>

<script>
    const url = 'http://localhost:3001/api/';
    var input = $('.validate-input .input100');

    $('.validate-form .input100').each(function(){
        $(this).focus(function(){
           hideValidate(this);
        });
    });

    function validate (input) {
        if($(input).attr('type') === 'email' || $(input).attr('name') === 'email') {
            if($(input).val().trim().match(/^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{1,5}|[0-9]{1,3})(\]?)$/) === null) {
                return false;
            }
        }
        else {
            if($(input).val().trim() === ''){
                return false;
            }
        }
    }

    function showValidate(input) {
        var thisAlert = $(input).parent();
        $(thisAlert).addClass('alert-validate');
    }

    function hideValidate(input) {
        var thisAlert = $(input).parent();
        $(thisAlert).removeClass('alert-validate');
    }

    var passwordInput = document.getElementById("password");
    passwordInput.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            register()
        }
    })
    var nicknameInput = document.getElementById("nickname");
    nicknameInput.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            register()
        }
    })

    var nameInput = document.getElementById("name");
    nameInput.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            register()
        }
    })
    var surnameInput = document.getElementById("surname");
    surnameInput.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            register()
        }
    })

    function login(params) {
        delete params['name']
        delete params['surname']
        $.ajax({
            url: url + 'auth',
            headers: {
                // 'Authorization': 'Basic xxxxxxxxxxxxx',
                'Content-Type': 'application/json; charset=UTF-8',
            },
            method: 'POST',
            dataType: 'json',
            data: params,
            success: (res) => {
                localStorage.setItem("auth", JSON.stringify(res))
                localStorage.setItem("profile", JSON.stringify({ id: res['id'], nickname: params['nickname'] }));
                sessionStorage.setItem("authToken", JSON.stringify({ Authorization: "Bearer " + res['accessToken'] }))

                let view = {
                    questions: 0,
                    groups: 0,
                    profiles: 1,
                }
                sessionStorage.setItem("view", JSON.stringify(view));

                sessionStorage.setItem("rangeView", JSON.stringify({ range: 20 }))

                localStorage.setItem("mapStyle", JSON.stringify({ mapStyle: 'mapbox://styles/mapbox/streets-v11' }));

                window.location.href = "http://localhost:3001/"
            },
            error: (err) => {
                console.log(err)
            }
        })
    }

    function register(){
        var check = true;

        for (var i = 0; i < input.length; i++) {
            if (validate(input[i]) === false) {
                showValidate(input[i]);
                check = false;
            }
        }

        if(check === true){
            localStorage.clear()
            sessionStorage.clear()
            
            let password = document.getElementById("password").value.trim()
            let nickname = document.getElementById("nickname").value.trim()
            let params = JSON.stringify({
                nickname: nickname,
                password: password,
                name: document.getElementById("name").value,
                surname: document.getElementById("surname").value,
            })

            $.ajax({
                url: url + 'profile/create',
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8',
                },
                method: 'POST',
                dataType: 'json',
                data: params,
                success: (res) => {
                    let myId = res['id']
                    login(params)
                },
                error: (err) => {
                    console.log(err)
                }
            })
        }
    }
    
</script>