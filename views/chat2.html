<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148651561-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-148651561-1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" type="text/css" href="localCDN/bootstrap.css">
    <!-- <link rel="stylesheet" type="text/css" href="localCDN/fontawesome.css"> -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <script src="localCDN/jquery.js"></script>
    <script src="localCDN/popper.js"></script>
    <script src="localCDN/bootstrap.js"></script>
</head>

<body>
    <div id="container">
        <div class="row" id="maindiv">
            <div class="col" style="padding: 0px;" id="persons">
                <div class="active-cyan-3 active-cyan-4 mb-4" style="padding: 20px; padding-bottom: 0px;">
                    <input class="form-control" type="text" placeholder="Search" aria-label="Search">
                </div>
                <div class="row person">
                    <div class="col-2" style=" padding: 0px;">
                        <img src="2787860.jpg" class="img-profile">
                    </div>
                    <div class="col" style="padding: 0px; padding-right: 10px; padding-top: 5px;">
                        <p style="font-size: 10px; float: right;">Yesterday</p>
                        <h1 class="title">ethryjrtyjdfgrtukyt</h1>
                        <p style="font-size: 14px;">ciaoyui;lyu;</p>
                    </div>
                </div>
                <hr/>
                <div class="row person">
                    <div class="col-2" style=" padding: 0px;">
                        <img src="2787860.jpg" class="img-profile">
                    </div>
                    <div class="col" style="padding: 0px; padding-right: 10px; padding-top: 5px;">
                        <p style="font-size: 10px; float: right;">Yesterday</p>
                        <h1 class="title">ethryjrtyjdfgrtukyt</h1>
                        <p style="font-size: 14px;">ciaoyui;lyu;</p>
                        
                    </div>
                </div>
                <hr />
                
            </div>
            <div class="col" style="padding: 0px;" id="chat">
                <header id="infoChat">
                    <div style=" padding: 0px; padding-left: 5px; padding-right: 10px;">
                        <img src="2787860.jpg" class="img-profile">
                    </div>
                    <h1 class="title">ethryjrtyjdfgrtukyt</h1>
                </header>
                <div id="messages">
                    <div class="message">
                        <img src="2787860.jpg" width="50px" height="50px" style="border-radius: 50px;">
                        <div class="col">
                            <div class="row">
                                <p style="padding-left: 10px; font-size: 14px; font-weight: bold;">Abdul</p>
                            </div>
                            <div class="row">
                                <p style="padding-left: 10px; font-size: 12px;">
                                    AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="myMessage">
                        <p  style="padding-left: 10px; font-size: 12px;">Hey ciao</p>
                    </div>
                    <div class="message">
                        <img src="2787860.jpg" width="50px" height="50px" style="border-radius: 50px;">
                        <div class="col">
                            <div class="row">
                                <p style="padding-left: 10px; font-size: 14px; font-weight: bold;">Abdul</p>
                            </div>
                            <div class="row">
                                <p style="padding-left: 10px; font-size: 12px;">
                                    AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <footer id="write">
                    <textarea id="textarea" name="text" placeholder="Write a message" wrap="soft"></textarea>
                    <button type="button" class="btn btn-info" id="send-btn">
                        <img src="icons/iconfinder_Sed-09_2236081.svg" width="50" height="50" style="position: relative;">
                    </button>
                </footer>
            </div>
        </div>
    </div>
    
</body>

</html>

<style>

    body {
        background-image: url('/background/annie-spratt-0ZPSX_mQ3xI-unsplash.jpg');
        /* background-position: center; */
        background-repeat: no-repeat;
        background-size: cover;
    }

    #send-btn {
        text-align:center;
        justify-content: center;
        align-items: center;
        border: 0;
        background: transparent;
        background-color: white;
        border-radius: 50px;
        height: 45px;
        width: 45px;
        height: auto;
        margin-left: 2px;
        margin-right: 10px;
        bottom:0;
        left:0;
        right:0;
    }

    #infoChat {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 70px; 
        width: 100%;
        left: 0px;
        background: white;
        border-bottom: 1px solid #dfdfdf; 
    }

    #messages {
        width: 100%;
        background: #F2F2F2;
        overflow-y: auto;
        position:absolute;
        top: 70px;
        bottom: 70px;
        left:0;
        right:0;
        padding: 7px;
        padding-bottom: 10px;
    }

    #write {
        display: flex;
        height: 50px; 
        width: 100%;
        margin: 0px;
        background: white;
        height: auto;
        text-align: center;
        position:absolute;
        bottom:0;
        left:0;
        right:0;
        border-top: 1px solid #dfdfdf; 
    }

    #textarea {
        height: 49px;
        width: calc(90% - 25px);
        font: inherit;
        background: #fff;
        border: none;
        padding: 14px 20px;
        box-sizing: border-box;
        transition: all .3s ease;
        resize:none;
        height: auto;
        word-break: break-all;
    }

    .message {
        display: flex;
        height: auto;
        width: 90%;
        background: white;
        border-radius: 10px;
        padding: 10px;
        margin: 5px;
        margin-bottom: 5px;
        word-break: break-all;
        box-shadow: 0 1px 0.5px rgba(0,0,0,.13);
    }

    .myMessage {
        display: flex;
        float: right;
        width: 90%;
        height: auto;
        background: #DCF8C6;
        border-radius: 10px;
        padding: 10px;
        margin: 5px;
        margin-bottom: 10px;
        word-break: break-all;
        box-shadow: 0 1px 0.5px rgba(0,0,0,.13);
    }

    hr {
        display: block;
        height: 1px;
        border: 0;
        border-top: 1px solid rgb(226, 226, 226);
        margin: 1em 0;
        padding: 0;
        width: 80%;
        margin: auto;
        margin-top: 10px;
        margin-bottom: 3px;
    }

    .person {
        margin: auto;
        width: 100%;
        height: 50px;
        display: flex;
        justify-content: center;
        /* align-items: center; */
    }

    #persons {
        padding-top: 20px;
        -ms-flex: 0 0 400px;
        flex: 0 0 400px;
        overflow-y: auto;
        max-height: 100%;
        border-right: 1px solid #dfdfdf; 
        background: white;
    }

    .img-profile{
        border-radius: 50%; 
        width: 50px;
        height: 50px;
        /* margin-top: 7px; */
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .title {
        /* margin-top: 7px; */
        font-size: 16px;
        font-weight: bold;
        /* float: left; */
    }

    .active-cyan-4 input[type=text]:focus:not([readonly]) {
        border: 1px solid #4dabe1;
        box-shadow: 0 0 0 1px #4dabe1;
    }
    .active-cyan-3 input[type=text] {
        border: 1px solid #4dabe1;
        box-shadow: 0 0 0 1px #4dabe1;
    }

    #container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
    }

    #maindiv {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
        width: 80%; 
        height: 95%;  
        box-shadow: 0 1px 1px 0 rgba(0,0,0,.06), 0 2px 5px 0 rgba(0,0,0,.2);
        word-break: break-all;
    }

    ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
    }

    @media only screen and (max-width:1500px) {
        #maindiv {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            width: 90%; 
            height: 90%; 
        }
    }

    @media only screen and (max-width:1000px) {
        #maindiv {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            width: 100%; 
            height: 100%; 
        }

        #chat {
            min-width:100%;
        }

        #persons {
            min-width:100%;
            display: none;
        }
    }

</style>

<script>
    window.WebSocket = window.WebSocket || window.MozWebSocket;
    const url = 'http://localhost:3001/api/';

    var noaccount = JSON.parse(localStorage.getItem("noaccount"))

    var authToken = JSON.parse(localStorage.getItem("authToken"))
    var profileData = JSON.parse(localStorage.getItem("profile"))
    function session() {
        if (authToken === null) {
            window.location.href = "http://localhost:3001/home"
        }
        refreshToken()
    }
    session()

    function refreshToken() {
        $.ajax({
            url: url + 'auth/refresh',
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'POST',
            dataType: 'json',
            success: (res) => {
                if (res["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))

                    openWebSocket()

                } else {
                    sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                    window.location.href = "http://localhost:3001/home"
                }
            },
            error: (err) => {
                sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                window.location.href = "http://localhost:3001/home"
            }
        })
    }
    window.setInterval(function () {
        refreshToken()
    }, 1700000);
    
    function openWebSocket() {
        var connection = new WebSocket('ws://localhost:1337');

        connection.onopen = function () {
            connection.send(JSON.stringify({ accessToken: authToken['accessToken'] }));
        };
        connection.onerror = function (error) {
        };
        connection.onmessage = function (message) {
            try {
                var json = JSON.parse(message.data);
            } catch (e) {
                return
            }
        };
    }
    

</script>