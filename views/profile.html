<html lang="en">

<head>
    <title>Profile</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148651561-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-148651561-1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" type="text/css" href="localCDN/bootstrap.css">
    <!-- <link rel="stylesheet" type="text/css" href="localCDN/fontawesome.css"> -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <script src="localCDN/jquery.js"></script>
    <script src="localCDN/popper.js"></script>
    <script src="localCDN/bootstrap.js"></script>
<!--     
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" onclick="window.location.href='http://localhost:3001/'">
            <img style="border-radius:50%;" src="/logo/Infinity Art iPhone Wallpaper.png" width="40" height="40"
                class="d-inline-block align-top" alt="">
        </a>
    </nav>

    <section class="hero-section">
        <div class="container-fluid">
            <div class="col-xl-10 offset-xl-1">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="hero-text">
                            <h2 id='nickname'></h2>
                            <h3 id='name-surname'></h3>
                            <p id='bio'></p>
                        </div>
                        <div class="hero-info">
                            <h2>General Info</h2>
                            <ul>
                                <li id='lastseen'><span>Last seen</span></li>
                                <li><span>Position</span><button id='position' type="button" class="btn btn-info">Show on map</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>

</html>

<style>
    html,body {
        height: 100%;
        background: #f2f7f8;
        font-family: 'Josefin Sans', sans-serif;
    }

    h1,h2,h3,h4,h5,h6 {
        color: #40424a;
        margin: 0;
        font-weight: 600;
        font-family: 'Josefin Sans', sans-serif;
    }

    h2 {
        font-size: 48px;
    }

    h3 {
        font-size: 30px;
    }

    p {
        font-size: 18px;
        color: #808181;
        line-height: 1.8;
    }

    img {
        max-width: 100%;
    }

    input:focus,
    select:focus,
    button:focus,
    textarea:focus {
        outline: none;
    }

    a:hover,
    a:focus {
        text-decoration: none;
        outline: none;
    }

    ul,
    ol {
        padding: 0;
        margin: 0;
    }

    .hero-section {
        background: #f2f7f8;
    }

    .hero-text {
        margin-bottom: 80px;
    }

    .hero-text h2 {
        font-size: 100px;
        line-height: normal;
        /* margin-bottom: 20px; */
    }

    .hero-text h3 {
        font-size: 50px;
        line-height: normal;
        margin-bottom: 20px;
    }

    .hero-text p {
        font-size: 33px;
        line-height: 1.3;
    }

    .hero-image {
        padding-top: 70px;
    }

    .hero-info h2 {
        margin-bottom: 30px;
    }

    .hero-info ul {
        list-style: none;
    }

    .hero-info ul li {
        font-size: 24px;
        color: #808181;
        margin-bottom: 15px;
    }

    .hero-info ul li span {
        color: #40424a;
        display: inline-block;
        min-width: 220px;
    }

    .hero-info ul li:last-child {
        margin-bottom: 0;
    }
</style>

<script>
    const url = 'http://localhost:3001/api/';
    var currentUrl = new URL(window.location.href);

    var authToken = JSON.parse(localStorage.getItem("authToken"))
    var profileData = JSON.parse(localStorage.getItem("profile"))
    function session(){
        if(authToken === null){
            window.location.href = "http://localhost:3001/login"
        }
        rangeView = JSON.parse(localStorage.getItem("rangeView")).range

        refreshToken(true)
    }
    session()

    function refreshToken(first=false) {
        $.ajax({
            url: url + 'auth/refresh',
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'POST',
            dataType: 'json',
            success: (res) => {
                if (res["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                } else {
                    window.location.href = "http://localhost:3001/login"
                }

                if(first){
                    var profileId = currentUrl.searchParams.get("nickname");
                    if (profileId != null) {
                        getProfile(profileId)
                    } else {
                        console.log("No profileId");
                    }
                }
            },
            error: (err) => {
                window.location.href = "http://localhost:3001/login"
            }
        })
    }
    window.setInterval(function () {
        refreshToken()
    }, 1700000);

    var offline = false
    $(document).mouseleave(function (e) {
        if (offline === false && canUpdateStatus === true) {
            offline = true
        }
    });
    $(document).click(function (e) {
        if(offline === true && canUpdateStatus === true){
            offline = false
        }
    });
    $(document).mouseenter(function (e) {
        if(offline === true && canUpdateStatus === true){
            offline = false
        }
    });
    window.setInterval(function () {
        if (offline === false && canUpdateStatus === true) {
            iamStatus(true)
        }
    }, 45000);
    function iamStatus(status) {
        let params = JSON.stringify({
            lastSeen: Date.now(),
            pos: { x: profileData['coords'][0], y: profileData['coords'][1] }
        })
        $.ajax({
            url: url + 'profile/' + profileData['id'],
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'PATCH',
            dataType: 'json',
            data: params,
            success: (res) => {
                if (res["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                    iamStatus(status)
                } else {
                    offline = !status
                }
            },
            error: (err) => {
                if(err['err'] === "Invalid access token"){
                    newAccessToken(() => iamStatus(status))
                } else if(err['err'] === "Invalid refresh token"){
                    authToken = null
                    localStorage.removeItem("authToken")
                    window.location.href = "http://localhost:3001/login"
                } else {
                    showAlertError(err['err'])
                }
            }
        })
    }

    // document.getElementById("closeAlert").onclick = function () {
    //     document.getElementById("showError").style.display = "none"
    //     document.getElementById("messageError").innerHTML = ""
    // }
    // function showAlertError(error) {
    //     document.getElementById("showError").style.display = "block";
    //     document.getElementById("messageError").innerText = error
    // }

    function timeConverter(UNIX_timestamp) {
        var a = new Date(UNIX_timestamp);
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var hour = a.getHours();
        var min = a.getMinutes();
        var sec = a.getSeconds();
        var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec;
        return time;
    }

    function getProfile(profileId) {
        $.ajax({
            url: url + 'profile/' + profileId,
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'GET',
            dataType: 'json',
            success: (profile) => {
                if (profile["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + profile['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                    getProfile(profileId)
                } else {
                    document.getElementById("nickname").innerHTML = profile["nickname"]
                    document.getElementById("name-surname").innerHTML = profile["name"] + " " + profile["surname"]
                    document.getElementById("bio").innerHTML = profile["bio"]
                    document.getElementById("position").onclick = function () {
                        sessionStorage.setItem("showOnMapProfile", JSON.stringify({ x: profile["pos"].x, y: profile["pos"].y }))
                        window.location.href = "http://localhost:3001/"
                    }
                    if (new Date() - profile["lastSeen"] < 60000) { // 1 minute
                        document.getElementById("lastseen").innerHTML = "<span>Last seen</span> Is online"
                    } else {
                        document.getElementById("lastseen").innerHTML = "<span>Last seen</span> " + timeConverter(profile["lastSeen"])
                    }
                }
            },
            error: (err) => {
                console.log(err)
                // if(err['err'] === "Invalid access token"){
                //     newAccessToken(() => getProfile(profileId))
                // } else if(err['err'] === "Invalid refresh token"){
                //     authToken = null
                //     localStorage.removeItem("authToken")
                //     window.location.href = "http://localhost:3001/login"
                // } else {
                //     showAlertError(err['err'])
                // }
            }
        })
    }
</script>