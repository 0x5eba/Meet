<html lang="en">

<head>
    <title>Profile</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148651561-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-148651561-1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" type="text/css" href="localCDN/bootstrap.css">
    <!-- <link rel="stylesheet" type="text/css" href="localCDN/fontawesome.css"> -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <script src="localCDN/jquery.js"></script>
    <script src="localCDN/popper.js"></script>
    <script src="localCDN/bootstrap.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/browser-image-compression@latest/dist/browser-image-compression.js"></script>
<!--     
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
</head>

<body>
    <div id="main">
        <!-- <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" onclick="window.location.href='http://localhost:3001/'">
                <img style="border-radius:50%;" src="/logo/Infinity Art iPhone Wallpaper.png" width="40" height="40"
                    class="d-inline-block align-top" alt="">
            </a>
        </nav> -->
        
        <div id="show-profile">
            <div id="div-img">
                <img id="img-profile">
                <button type="button" class="btn" id="btn-edit-profile" onclick="editProfile()">Edit info</button>
                <button type="button" class="btn" id="icon-show-on-map"><img src="icons/iconfinder_map_285662.svg" width="20" height="20"></button>
            </div>
            
            <div class="info">
                <p id='name-surname' style="margin: 0px;"></p>
                <p id='nickname' style="margin: 0px;"></p>
                <p id='lastseen' style="margin: 0px; font-size: 12"></p>
                <p id='kmaway' style="margin: 0px; font-size: 12"></p>
                <hr style="border-top: 1px solid rgb(230, 230, 230);">
                <p id='bio'></p>
            </div>
        </div>

        <div id="edit-profile">
            <div style="width: 100%;">
                <img id="img-profile-edit" style="border-radius: 50%; width: 150px; height: 150px;">

                <div class="image-upload" style="margin-top: 10px;">
                    <label for="input-change-photo" style="color: rgb(68, 133, 207)">
                        Change photo <img src="icons/iconfinder_179_Upload_183298.svg" />
                    </label>
                    <input type="file" id="input-change-photo" accept="image/*" name="photo" />
                </div>
                
            </div>
            <div class="input-icons">
                <i class="fa fa-user icon"></i>
                <input class="myinput" type="text" id='name' name="name" placeholder="Name">
            </div>
            <div class="input-icons">
                <i class="fa fa-user icon"></i>
                <input class="myinput" type="text" id='surname' name="surname" placeholder="Surname">
            </div>
            <textarea name="text" id="textarea-bio" placeholder="Bio" wrap="soft"></textarea>
            <div style="width: 100%;">
                <button class="transparent-btn" id="btn-save" style="margin-top: 20px; font-size: 20px; color: rgb(63, 218, 84)" onclick="sendImage()">Save</button>
            </div>
        </div>
        
    </div>
</body>

</html>

<style>
    .image-upload>input {
        display: none;
    }

    .input-icons { 
        color: rgb(205, 206, 206);
        justify-content: center;
        align-items: center;
        padding: 10px;
        padding-right: 20px;
    }
    .myinput {
        background-color: Transparent;
        background-repeat:no-repeat;
        border: none;
        border-bottom: 1px solid rgb(180, 179, 179);
        padding: 7px;
        padding-left: 2px;
    }
    #textarea-bio {
        width: 80%;
        font: inherit;
        background: #fff;
        margin: 20px;
        padding: 10px 10px;
        box-sizing: border-box;
        /* transition: all .3s ease; */
        resize:none;
        border: 1px solid #adacac; 
        border-radius:10px;
    }
    .transparent-btn {
        background-color: Transparent;
        background-repeat:no-repeat;
        border: none;
        cursor:pointer;
        /* color: rgb(126, 129, 129); */
        color: rgb(216, 66, 66);
    }
    #edit-profile {
        display: none;
        padding: 20px; 
        text-align: center;
    }

    #main {
        position: absolute;
        z-index: 1;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
        margin-top: 0px;
        border: 1px solid #888;
        background-color: #fefefe;
        /* padding: 20px; */
        width: 100%;
        height: 100%;
        max-width: 500px;
        overflow-y: scroll;
        overflow: auto;
    }

    .info {
        margin: 15px;
        word-wrap: break-word;
        color: rgb(107, 107, 107);
    }
    #name-surname {
        color: rgb(59, 59, 59);
        font-weight: bold;
        font-size: 20px;
    }
    #nickname {
        font-size: 16px;
    }
    #last-seen {
        font-size: 12px;
    }
    #icon-show-on-map {
        position: absolute;
        text-align: center;
        margin: 0 auto;
        display: table-cell;
        vertical-align: middle;
        top: 8px;
        left: 8px;
        border-radius: 50px;
        width: 40px;
        height: 40px;
        background: white;
        border: 0;
    }

    #div-img {
        text-align:center; 
        margin: 0 auto;
    }
    #img-profile {
        width: 100%; 
        max-width: 500px; 
        height: auto;
    }
    #img-profile-edit{
        width: 100%; 
        max-width: 500px; 
        height: auto;
    }

    #btn-edit-profile {
        position: absolute;
        display: none;
        top: 8px;
        right: 8px;
        border-radius: 30px;
        color: white;
        background: rgb(121, 121, 121);
        padding: 3px;
        padding-left: 10px;
        padding-right: 10px;
        font-size: 12px;
    }

</style>

<script>
    const url = 'http://localhost:3001/api/'
    var currentUrl = new URL(window.location.href)
    var currProfile

    var noaccount = JSON.parse(localStorage.getItem("noaccount"))

    var authToken = JSON.parse(localStorage.getItem("authToken"))
    var profileData = JSON.parse(localStorage.getItem("profile"))
    function session(){
        if (authToken === null) {
            window.location.href = "http://localhost:3001/home"
        }
        refreshToken(true)
    }
    session()

    function refreshToken(first=false) {
        $.ajax({
            url: url + 'auth/refresh',
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'POST',
            dataType: 'json',
            success: (res) => {
                if (res["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                } else {
                    sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                    window.location.href = "http://localhost:3001/home"
                }

                if(first){
                    var profileId = currentUrl.searchParams.get("nickname");
                    if (profileId != null) {
                        getProfile(profileId)
                    } else {
                        console.log("No profileId");
                    }
                }
            },
            error: (err) => {
                sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                window.location.href = "http://localhost:3001/home"
            }
        })
    }
    window.setInterval(function () {
        refreshToken()
    }, 1700000);

    var offline = false
    $(document).mouseleave(function (e) {
        if (offline === false) {
            offline = true
        }
    });
    $(document).click(function (e) {
        if(offline === true){
            offline = false
        }
    });
    $(document).mouseenter(function (e) {
        if(offline === true){
            offline = false
        }
    });
    if(noaccount === null){
        window.setInterval(function () {
            if (offline === false) {
                iamStatus(true)
            }
        }, 45000);
    }
    function iamStatus(status) {
        let params = JSON.stringify({
            lastSeen: Date.now(),
        })
        $.ajax({
            url: url + 'profile/' + profileData['id'],
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'PATCH',
            dataType: 'json',
            data: params,
            success: (res) => {
                if (res["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                    iamStatus(status)
                } else {
                    offline = !status
                }
            },
            error: (err) => {
                if(err['err'] === "Invalid access token"){
                    newAccessToken(() => iamStatus(status))
                } else if(err['err'] === "Invalid refresh token"){
                    authToken = null
                    localStorage.removeItem("authToken")
                    sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                    window.location.href = "http://localhost:3001/home"
                } else {
                    showAlertError(err['err'])
                }
            }
        })
    }

    function editProfile(){
        $("#show-profile").hide()
        $("#edit-profile").show()
        $("#name").val(currProfile['name'])
        $("#surname").val(currProfile['surname'])
        $("#textarea-bio").val(currProfile['bio'])
    }

    function saveProfile(){
        let params = JSON.stringify({
            name: $("#name").val(),
            surname: $("#surname").val(),
            bio: $("#textarea-bio").val(),
        })
        $.ajax({
            url: url + 'profile/' + profileData['id'],
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'PATCH',
            dataType: 'json',
            data: params,
            success: (res) => {
                if (res["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                    saveProfile()
                } else {
                    console.log("Saved")
                    window.location.reload()
                }
            },
            error: (err) => {
                if(err['err'] === "Invalid access token"){
                    newAccessToken(() => saveProfile())
                } else if(err['err'] === "Invalid refresh token"){
                    authToken = null
                    localStorage.removeItem("authToken")
                    sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                    window.location.href = "http://localhost:3001/home"
                } else {
                    // showAlertError(err['err'])
                    console.log(err)
                }
            }
        })
    }

    function sendImage() {
        if(lastPhotoInserted === null){
            saveProfile()
            return
        }

        var options = {
            maxSizeMB: 0.5,
            // maxWidthOrHeight: 720,
            useWebWorker: true
        }
        imageCompression(lastPhotoInserted, options)
            .then(function (compressedFile) {
                // console.log('compressedFile instanceof Blob', compressedFile instanceof Blob); // true
                // console.log(`compressedFile size ${compressedFile.size / 1024 / 1024} MB`); // smaller than maxSizeMB

                var formData = new FormData();
                formData.append("file", compressedFile);

                $.ajax({
                    url: url + 'profile/uploadPic/' + profileData['id'],
                    headers: {
                        'Authorization': authToken['accessToken'],
                    },
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: (res) => {
                        if (res["accessToken"] !== undefined) {
                            localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
                            authToken = JSON.parse(localStorage.getItem("authToken"))
                            sendImage()
                        } else {
                            saveProfile()
                        }
                    },
                    error: (err) => {
                        if (err['err'] === "Invalid access token") {
                            newAccessToken(() => sendImage())
                        } else if (err['err'] === "Invalid refresh token") {
                            authToken = null
                            localStorage.removeItem("authToken")
                            sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
                            window.location.href = "http://localhost:3001/home"
                        } else {
                            // showAlertError(err['err'])
                            console.log(err)
                        }
                    }
                });
            })
            .catch(function (error) {
                console.log(error.message);
            });

        // var formData = new FormData();
        // formData.append("file", lastPhotoInserted);

        // $.ajax({
        //     url: url + 'profile/uploadPic/' + profileData['id'],
        //     headers: {
        //         'Authorization': authToken['accessToken'],
        //     },
        //     type: "POST",
        //     data: formData,
        //     processData: false,
        //     contentType: false,
        //     success: (res) => {
        //         if (res["accessToken"] !== undefined) {
        //             localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + res['accessToken'] }))
        //             authToken = JSON.parse(localStorage.getItem("authToken"))
        //             sendImage()
        //         } else {
        //             saveProfile()
        //         }
        //     },
        //     error: (err) => {
        //         if (err['err'] === "Invalid access token") {
        //             newAccessToken(() => sendImage())
        //         } else if (err['err'] === "Invalid refresh token") {
        //             authToken = null
        //             localStorage.removeItem("authToken")
        //             sessionStorage.setItem("loginAgain", JSON.stringify({ loginAgain: true }))
        //             window.location.href = "http://localhost:3001/home"
        //         } else {
        //             // showAlertError(err['err'])
        //             console.log(err)
        //         }
        //     }
        // });
    }

    var lastPhotoInserted = null
    $('#input-change-photo').change(function (){
        var blobFile = this.files[0];
        lastPhotoInserted = blobFile

        const imageType = /image.*/

        if (!blobFile.type.match(imageType)) {
            alert('Sorry, only images are allowed')
            return
        }
        if (blobFile.size > (5120000)) {
            alert('Sorry, the max allowed size for images is 5 Megabyte')
            return
        }

        var urlImg = window.URL.createObjectURL(blobFile);
        document.getElementById("img-profile-edit").src = urlImg;
    })

    // document.getElementById("closeAlert").onclick = function () {
    //     document.getElementById("showError").style.display = "none"
    //     document.getElementById("messageError").innerHTML = ""
    // }
    // function showAlertError(error) {
    //     document.getElementById("showError").style.display = "block";
    //     document.getElementById("messageError").innerText = error
    // }

    function getDistance(lat1, long1, lat2, long2) {
        return Math.round(Math.acos(Math.sin(lat2 * Math.PI / 180.0) * Math.sin(lat1 * Math.PI / 180.0) +
            Math.cos(lat2 * Math.PI / 180.0) * Math.cos(lat1 * Math.PI / 180.0) *
            Math.cos((long1 - long2) * Math.PI / 180.0)) * 6371);
    }

    function timeConverter(UNIX_timestamp) {
        var a = new Date(UNIX_timestamp);
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var hour = (a.getHours().length === 1) ? "0" + a.getHours() : a.getHours();
        var min = (a.getMinutes().length === 1) ? "0" + a.getMinutes() : a.getMinutes();
        var time = date + ' ' + month + ' ' + hour + ':' + min;
        return time;
    }

    function getProfile(profileId) {
        if(profileId === profileData['id']){
            $("#btn-edit-profile").show()
        }

        $.ajax({
            url: url + 'profile/' + profileId,
            headers: {
                'Authorization': authToken['accessToken'],
                'Content-Type': 'application/json; charset=UTF-8',
            },
            credentials: 'include',
            method: 'GET',
            dataType: 'json',
            success: (profile) => {
                if (profile["accessToken"] !== undefined) {
                    localStorage.setItem("authToken", JSON.stringify({ accessToken: "Bearer " + profile['accessToken'] }))
                    authToken = JSON.parse(localStorage.getItem("authToken"))
                    getProfile(profileId)
                } else {
                    currProfile = profile
                    document.getElementById("nickname").innerHTML = profile["nickname"]
                    document.getElementById("name-surname").innerHTML = profile["name"] + " " + profile["surname"]
                    document.getElementById("bio").innerHTML = profile["bio"]
                    document.getElementById("icon-show-on-map").onclick = function () {
                        sessionStorage.setItem("showOnMapProfile", JSON.stringify({ x: profile["pos"].x, y: profile["pos"].y }))
                        window.location.href = "http://localhost:3001/"
                    }
                    let lastseen = document.getElementById("lastseen")
                    if(profileData['coords'][0] === 0 && profileData['coords'][1] === 0){
                        var dist = getDistance(profile["pos"].x, profile["pos"].y, profileData['fakePos'][0], profileData['fakePos'][1])
                    } else {
                        var dist = getDistance(profile["pos"].x, profile["pos"].y, profileData['coords'][0], profileData['coords'][1])
                    }
                    
                    if (new Date() - profile["lastSeen"] < 60000) { // 1 minute
                        lastseen.innerHTML = "Online"  + ",  " + dist + " km away"
                    } else {
                        lastseen.innerHTML = timeConverter(profile["lastSeen"]) + ",  " + dist + " km away"
                    }
                    
                    if(profile.pic !== ""){
                        $.ajax({
                            url: url + 'profile/getPic/' + profile.pic,
                            headers: {
                                'Authorization': authToken['accessToken'],
                                'Content-Type': 'image/jpg',
                            },
                            xhrFields: {
                                responseType: 'blob'
                            },
                            credentials: 'include',
                            method: 'GET',
                            success: (res) => {
                                var reader = new FileReader();
                                reader.readAsDataURL(res);
                                reader.onloadend = function () {
                                    var base64data = reader.result;
                                    document.getElementById("img-profile").src = base64data;
                                    document.getElementById("img-profile-edit").src = base64data;
                                }
                            },
                            error: (err) => {
                                console.log(res)
                            }
                        })
                    } else {
                        document.getElementById("img-profile").src = "NoGPS.png";
                        document.getElementById("img-profile-edit").src = "NoGPS.png";
                    }
                }
            },
            error: (err) => {
                console.log(err)
                // if(err['err'] === "Invalid access token"){
                //     newAccessToken(() => getProfile(profileId))
                // } else if(err['err'] === "Invalid refresh token"){
                //     authToken = null
                //     localStorage.removeItem("authToken")
                //     window.location.href = "http://localhost:3001/home"
                // } else {
                //     showAlertError(err['err'])
                // }
            }
        })
    }
</script>